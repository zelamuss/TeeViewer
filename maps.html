    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Maps - TeeViewer</title>
        <link rel="stylesheet" href="style.css">
        <style>
            /* General styling from your first code snippet (for filters) */
            .maps-container {
                max-width: 1200px;
                margin: 20px auto;
                padding: 0 20px;
            }

            .search-filters {
                display: flex;
                gap: 15px;
                margin-bottom: 30px;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center; /* Center the filter elements */
            }

            .search-input {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                padding: 12px 20px;
                color: var(--text-color);
                font-family: 'SF Pro Rounded', sans-serif;
                font-size: 16px;
                min-width: 300px;
                transition: all 0.3s ease;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 15px rgba(255, 69, 0, 0.3);
            }

            .filter-select {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                padding: 12px 15px;
                color: var(--text-color);
                font-family: 'SF Pro Rounded', sans-serif;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .filter-select:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            /* Existing styles from your second code snippet */
            .map-search-container {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                margin: 40px auto;
            }

            .map-searcher-title {
                font-size: 36px;
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 20px;
                text-shadow: 0 0 20px rgba(255, 137, 27, 0.6);
                animation: glow 2s ease-in-out infinite alternate;
            }

            #mapsTable {
                border-spacing: 0px;
                border-collapse: collapse;
                margin: 30px auto;
                width: 95%;
                text-align: center;
                max-width: 1200px;
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                font-size: 16px;
                animation: fadeInUp 1s ease-out 0.3s both;
            }

            #mapsTable th {
                background: rgba(255, 69, 0, 0.1);
                color: var(--primary-color);
                padding: 15px;
                font-weight: 600;
                border-style: none;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            #mapsTable th:hover {
                background: rgba(255, 69, 0, 0.2);
            }

            #mapsTable td {
                padding: 15px;
                transition: background-color 0.2s ease;
                border-style: none;
                color: var(--primary-color);
            }

            .map-row {
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .map-row:hover {
                background: rgba(255, 69, 0, 0.05);
            }

            .map-row.expanded {
                background: rgba(255, 69, 0, 0.08);
            }

            .map-details {
                display: none;
                background: rgba(255, 69, 0, 0.03);
                border-top: 1px solid rgba(255, 69, 0, 0.2);
            }

            .map-details.show {
                display: table-row;
                animation: fadeInDown 0.3s ease-out;
            }

            .map-content {
                display: flex;
                padding: 20px;
                gap: 20px;
                align-items: flex-start;
            }

            .map-stats {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 15px;
                background: var(--glass-bg);
                border-radius: 6px;
                border: 1px solid var(--glass-border);
            }

            .stat-label {
                color: var(--primary-color);
                font-weight: 600;
            }

            .stat-value {
                color: var(--text-color);
            }

            .map-preview-container {
                flex: 1;
                max-width: 500px;
                position: relative;
                
            }

            .map-preview {
                width: 100%;
                height: 332px;
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                background: var(--glass-bg);
                position: relative;
                overflow: hidden;
            }

            .map-preview iframe {
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .map-preview:hover iframe {
                transform: scale(1.02);
            }

            .preview-loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                color: var(--text-color);
            }

            .preview-error {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #ff4444;
                text-align: center;
            }

            .maximize-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: var(--primary-color);
                border: none;
                border-radius: 4px;
                padding: 8px;
                cursor: pointer;
                color: white;
                font-size: 12px;
                z-index: 10;
                transition: all 0.3s ease;
            }

            .maximize-btn:hover {
                background: #ff3300;
                transform: scale(1.1);
            }

            .type-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
                color: white;
            }

            .type-novice { background: linear-gradient(135deg, #4CAF50, #45a049); }
            .type-moderate { background: linear-gradient(135deg, #FF9800, #f57c00); }
            .type-brutal { background: linear-gradient(135deg, #f44336, #d32f2f); }
            .type-insane { background: linear-gradient(135deg, #9C27B0, #7b1fa2); }
            .type-dummy { background: linear-gradient(135deg, #795548, #5d4037); }
            .type-ddmax { background: linear-gradient(135deg, #607D8B, #455a64); }
            .type-oldschool { background: linear-gradient(135deg, #9E9E9E, #616161); }
            .type-solo { background: linear-gradient(135deg, #3F51B5, #303f9f); }
            .type-race { background: linear-gradient(135deg, #E91E63, #c2185b); }
            .type-fun { background: linear-gradient(135deg, #FFEB3B, #fbc02d); color: #333; }

            .active-servers-btn {
                background: var(--primary-color);
                border: none;
                border-radius: 6px;
                padding: 6px 12px;
                color: white;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .active-servers-btn:hover {
                background: #ff3300;
                transform: scale(1.05);
            }

            .servers-popup {
                text-align: center;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                padding: 20px;
                max-width: 1200px;
                width: 900px;
                max-height: 900px;
                overflow-y: auto;
                z-index: 1000;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                display: none;
                animation: fadeInScale 0.3s ease-out;
                font-size: 20px;
            }

            .servers-popup.show {
                display: block;
            }

            .popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }

            .popup-overlay.show {
                display: block;
            }

            .server-item {
                padding: 10px;
                margin: 5px 0;
                background: rgba(255, 69, 0, 0.1);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 1px solid transparent;
            }

            .server-item:hover {
                background: rgba(255, 69, 0, 0.2);
                border-color: var(--primary-color);
                transform: translateX(5px);
            }

            .server-name {
                font-weight: 600;
                color: var(--primary-color);
            }

            .server-info {
                font-size: 12px;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 5px;
            }

            .close-popup {
                position: absolute;
                top: 10px;
                right: 15px;
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 20px;
                cursor: pointer;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 69, 0, 0.3);
                border-radius: 50%;
                border-top-color: var(--primary-color);
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            .maximized-preview {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 2000;
                background: rgba(0, 0, 0, 0.9);
                display: none;
                align-items: center;
                justify-content: center;
            }

            .maximized-preview.show {
                display: flex;
            }

            .maximized-preview iframe {
                width: 90vw;
                height: 90vh;
                border-radius: 8px;
            }

            .stars {
                color: #FFD700;
            }

            /* Individual Map Page Styles */
            .individual-map-container {
                max-width: 1200px;
                margin: 20px auto;
                padding: 0 20px;
                display: none; /* Hidden by default */
            }

            .individual-map-container.show {
                display: block;
            }

            .back-button {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                padding: 12px 20px;
                color: var(--primary-color);
                font-family: 'SF Pro Rounded', sans-serif;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-bottom: 20px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .back-button:hover {
                background: rgba(255, 69, 0, 0.1);
                border-color: var(--primary-color);
                transform: translateX(-5px);
            }

            .map-header {
                text-align: center;
                margin-bottom: 40px;
            }

            .map-title {
                font-size: 48px;
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 10px;
                text-shadow: 0 0 20px rgba(255, 137, 27, 0.6);
                animation: glow 2s ease-in-out infinite alternate;
            }

            .map-subtitle {
                font-size: 18px;
                color: rgba(255, 255, 255, 0.7);
                margin-bottom: 20px;
            }

            .map-main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 40px;
                margin-bottom: 40px;
            }

            .map-info-section, .map-preview-section, .servers-section, .rankings-section, .playtime-section, .server-table-section {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            .rankings-section, .playtime-section, .server-table-section {
                grid-column: 1 / -1; /* Span full width */
            }

            .section-title {
                font-size: 24px;
                font-weight: 600;
                color: var(--primary-color);
                margin-bottom: 20px;
                text-align: center;
            }

            .large-stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: rgba(255, 69, 0, 0.05);
                border-radius: 8px;
                border: 1px solid rgba(255, 69, 0, 0.1);
                margin-bottom: 15px;
            }

            .large-stat-label {
                color: var(--primary-color);
                font-weight: 600;
                font-size: 16px;
            }

            .large-stat-value {
                color: var(--text-color);
                font-size: 16px;
            }

            .map-preview-section {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }

            .large-map-preview {
                width: 100%;
                height: 90%;
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                background: var(--glass-bg);
                position: relative;
                overflow: hidden;
            }

            .large-map-preview iframe {
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 8px;
            }

            .servers-section {
                background: var(--glass-bg);
                backdrop-filter: blur(15px);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                grid-column: 1 / -1;
            }

            .servers-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }

            .large-server-item {
                padding: 15px;
                background: rgba(255, 69, 0, 0.1);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 1px solid rgba(255, 69, 0, 0.2);
            }

            .large-server-item:hover {
                background: rgba(255, 69, 0, 0.2);
                border-color: var(--primary-color);
                transform: translateY(-2px);
            }

            .large-server-name {
                font-weight: 600;
                color: var(--primary-color);
                margin-bottom: 8px;
                font-size: 16px;
            }

            .large-server-info {
                color: rgba(255, 255, 255, 0.7);
                font-size: 14px;
                line-height: 1.4;
            }

            /* Tables for rankings and live servers */
            .map-data-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }

            .map-data-table th, .map-data-table td {
                text-align: center;
                padding: 12px 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
                color: var(--primary-color);
            }

            .map-data-table th {
                background-color: rgba(255, 255, 255, 0.05);
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }

            .map-data-table tr:hover {
                background-color: rgba(255, 255, 255, 0.02);
            }

            /* Styles for server details popup */
            .server-client-list-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            .server-client-list-table th, .server-client-list-table td {
                padding: 8px 5px;
                text-align: center;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                font-size: 14px;
                color: var(--text-color);
            }
            .server-client-list-table th {
                color: var(--primary-color);
                font-weight: 600;
                background-color: rgba(255, 255, 255, 0.05);
                text-align: center;
            }
            .server-client-list-table tr:last-child td {
                border-bottom: none;
            }
            .server-client-list-table img {
                vertical-align: middle;
                margin-right: 5px;
                width: 18px; /* Adjust flag size */
                height: auto;
                border-radius: 2px;
            }
            .server-client-list-table td:nth-child(2) { /* For player name */
                font-weight: 600;
            }

            @media (max-width: 768px) {
                .map-content {
                    flex-direction: column;
                }
                
                .map-preview-container {
                    max-width: 100%;
                }
                
                #mapSearch {
                    min-width: auto;
                    width: 90%;
                }

                .search-filters {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .filter-select {
                    width: 100%;
                }

                .servers-popup {
                    width: 90%;
                    max-width: none;
                }

                .map-main-content {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }

                .map-title {
                    font-size: 36px;
                }

                .servers-grid {
                    grid-template-columns: 1fr;
                }
                .server-client-item {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .server-client-item span {
                    margin-bottom: 5px;
                }

                .server-client-list-table th, .server-client-list-table td {
                    padding: 6px 3px; /* Smaller padding for mobile */
                    font-size: 12px;
                }
                .server-client-list-table img {
                    width: 14px; /* Smaller flags on mobile */
                }
            }
        </style>
    </head>
    <body>
        <div class="topbar">
            <img onclick="navigateToPage('index.html')" class="logo" src="logo.png" alt="TeeViewer Logo">
            <div class="nav-buttons">
            <button onclick="navigateToPage('players.html')" class="categories" id="players">Players</button>
            <button onclick="navigateToPage('clans.html')"class="categories" id="clans">Clans</button>
            <button onclick="navigateToPage('maps.html')"class="categories" id="maps">Maps</button>
            <button onclick="navigateToPage('servers.html')"class="categories" id="servers">Servers</button>
                <button onclick="window.location.href='https://discord.com/oauth2/authorize?client_id=1391161122714943528&permissions=117760&scope=bot+applications.commands'" class="categories" id="servers">Discord Bot</button>
            <button onclick="navigateToPage('status.html')" class="categories" id="status">Status</button>
            </div>
        </div>

        <!-- Main Maps Browser -->
        <div class="maps-container" id="mapsBrowser">
            <h1 style="text-align: center; color: var(--primary-color); font-size: 36px; margin-bottom: 30px; text-shadow: 0 0 10px rgba(255, 137, 27, 0.3);">
                Map Browser
            </h1>

            <div class="search-filters">
                <input type="text" id="mapSearch" class="search-input" placeholder="Search maps by name or mapper...">
                
                <select id="typeFilter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="Novice">Novice</option>
                    <option value="Moderate">Moderate</option>
                    <option value="Brutal">Brutal</option>
                    <option value="Insane">Insane</option>
                    <option value="Dummy">Dummy</option>
                    <option value="DDmaX">DDmaX</option>
                    <option value="Oldschool">Oldschool</option>
                    <option value="Solo">Solo</option>
                    <option value="Race">Race</option>
                    <option value="Fun">Fun</option>
                </select>

                <select id="sortBy" class="filter-select">
                    <option value="map">Sort by Map Name</option>
                    <option value="points">Sort by Points</option>
                    <option value="stars">Sort by Stars</option>
                    <option value="timestamp">Sort by Release Date</option>
                </select>
            </div>

            <table id="mapsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('map')">Map Name</th>
                        <th onclick="sortTable('server')">Type</th>
                        <th onclick="sortTable('points')">Points</th>
                        <th onclick="sortTable('stars')">Stars</th>
                        <th onclick="sortTable('mapper')">Mapper</th>
                        <th onclick="sortTable('timestamp')">Release Date</th>
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id="mapsTableBody">
                    <tr>
                        <td colspan="7" style="padding: 40px;">
                            <div class="loading" style="margin: 0 auto;"></div>
                            <div style="margin-top: 15px;">Loading maps...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Individual Map Page -->
        <div class="individual-map-container" id="individualMap">
            <button class="back-button" onclick="goBackToMapBrowser()">
                ← Back to Map Browser
            </button>

            <div class="map-header">
                <h1 class="map-title" id="individualMapTitle">Map Name</h1>
                <p class="map-subtitle" id="individualMapSubtitle">Loading map information...</p>
            </div>
            
            <div class="map-main-content">
                <!-- Overview Section -->
                <div class="map-info-section">
                    <h2 class="section-title">Overview</h2>
                    <div id="individualMapInfo">
                        <div class="large-stat-item">
                            <span class="large-stat-label">Loading...</span>
                            <span class="large-stat-value">Please wait</span>
                        </div>
                    </div>
                </div>

                <!-- Map Preview Section -->
                <div class="map-preview-section">
                    <h2 class="section-title">Map Preview</h2>
                    <div class="large-map-preview" id="individualMapPreview">
                        <div class="preview-loading">
                            <div class="loading"></div>
                            <div>Loading preview...</div>
                        </div>
                        <button class="maximize-btn" onclick="maximizeIndividualPreview()">⛶</button>
                    </div>
                </div>


                <!-- Server Details Table Section -->
                <div class="server-table-section">
                    <h2 class="section-title">Servers</h2>
                    <table class="map-data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Players</th>

                                <th>Gametype</th>
                                <th>Version</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="detailedServersTableBody">
                            <tr>
                                <td colspan="6" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">Loading detailed server list...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <!-- Rankings Section -->
                <div class="rankings-section">
                    <h2 class="section-title">Top 10 Individual Rankings</h2>
                    <table class="map-data-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Time</th>
                                <th>Diff</th>
                                <th>Date</th>
                                <th>Server</th>
                            </tr>
                        </thead>
                        <tbody id="mapRankingsTableBody">
                            <tr>
                                <td colspan="6" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">Loading rankings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Player Playtime Section -->
                <div class="playtime-section">
                    <h2 class="section-title">Top 10 Player Playtime</h2>
                    <table class="map-data-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Time Played</th>
                            </tr>
                        </thead>
                        <tbody id="mapPlaytimeTableBody">
                            <tr>
                                <td colspan="3" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">Loading playtime data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Popup for general map browser servers -->
        <div class="popup-overlay" id="popupOverlay"></div>
        <div class="servers-popup" id="serversPopup">
            <button class="close-popup" onclick="closeServersPopup()">&times;</button>
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">Active Servers</h3>
            <div id="serversList"></div>
        </div>

        <!-- Popup for individual map preview maximization -->
        <div class="maximized-preview" id="maximizedPreview">
            <button class="close-popup" onclick="closeMaximizedPreview()" style="position: absolute; top: 20px; right: 30px; font-size: 30px; z-index: 2001;">&times;</button>
            <iframe id="maximizedIframe"></iframe>
        </div>

        <!-- New Popup for detailed live server information from individual map page -->
        <div class="popup-overlay" id="serverDetailsOverlay"></div>
        <div class="servers-popup" id="serverDetailsPopup">
            <button class="close-popup" onclick="closeServerDetailsPopup()">&times;</button>
            <h3 id="serverDetailsTitle" style="color: var(--primary-color); margin-bottom: 15px;">Server Details</h3>
            <div id="serverDetailsContent" style="color: var(--text-color);">
                <!-- Server details and client list will be inserted here -->
            </div>
        </div>

        <script>
            let allMaps = [];
            let currentSort = { column: 'map', direction: 'asc' };
            let filteredAndSortedMaps = [];
            let currentIndividualMap = null; // Stores data from ddstats.tw/map/json
            let currentLiveServerData = null; // Stores data from api.status.tw/map/name

            // Function to navigate to a different HTML page
            function navigateToPage(url) {
                document.body.style.transform = 'translateX(-100%)';
                document.body.style.transition = 'transform 0.5s ease-in-out';
                setTimeout(() => {
                    window.location.href = url;
                }, 250);
            }

            // --- Helper Functions ---

            // Helper to format timestamp to date
            function formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp); 
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            // Helper to format time in seconds to human-readable format (e.g., 1h 30m 15s)
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds === null) return 'N/A';
                seconds = Math.round(seconds); 

                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;

                let parts = [];
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (remainingSeconds > 0 || (hours === 0 && minutes === 0 && seconds === 0)) parts.push(`${remainingSeconds}s`);

                return parts.join(' ') || '0s';
            }

            // Helper to format time in seconds to "Xm Y.ZZs (Total.ZZs)" format
            function formatTimeDetailed(seconds) {
                if (isNaN(seconds) || seconds === null) return 'N/A';
                const totalSeconds = parseFloat(seconds);
                const minutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = (totalSeconds % 60); 
                
                let parts = [];
                if (minutes > 0) {
                    parts.push(`${minutes}m`);
                }
                // Always show seconds, even if 0, to maintain consistent format "Xm Y.ZZs"
                parts.push(`${remainingSeconds.toFixed(2)}s`);

                return `${parts.join(' ')} (${totalSeconds.toFixed(2)}s)`;
            }

            // Helper to get CSS class for map type badge
            function getTypeClass(serverType) {
                if (!serverType) return 'type-unknown';
                const normalizedType = serverType.toLowerCase().replace(/[^a-z0-9]/g, ''); 
                const knownTypes = ['novice', 'moderate', 'brutal', 'insane', 'dummy', 'ddmax', 'oldschool', 'solo', 'race', 'fun'];
                if (knownTypes.includes(normalizedType)) {
                    return `type-${normalizedType}`;
                }
                if (normalizedType.startsWith('ddmax')) {
                    return 'type-ddmax';
                }
                return 'type-unknown'; 
            }

            // --- Toast Notification ---
            function showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: ${isError ? '#ff4444' : '#4CAF50'};
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 2000;
                    opacity: 0;
                    transition: opacity 0.3s ease-in-out;
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10); 

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            // --- Map Browser Functions ---

            // Fetch maps data using ddstats.tw/maps/json
            async function loadMaps() {
                try {
                    const response = await fetch('https://ddstats.tw/maps/json');
                    const data = await response.json();
                    allMaps = data.sort((a, b) => a.map.localeCompare(b.map)); 
                    filterAndSortMaps();
                } catch (error) {
                    console.error('Error loading maps:', error);
                    document.getElementById('mapsTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" style="color: #ff4444; padding: 20px;">Failed to load maps. Please try again later.</td>
                        </tr>
                    `;
                }
            }

            // Filter and sort maps based on current criteria
            function filterAndSortMaps() {
                const searchTerm = document.getElementById('mapSearch').value.toLowerCase();
                const typeFilter = document.getElementById('typeFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                filteredAndSortedMaps = allMaps.filter(map => {
                    const matchesSearch = map.map.toLowerCase().includes(searchTerm) ||
                                        (map.mapper && map.mapper.toLowerCase().includes(searchTerm));
                    const matchesType = typeFilter === '' || map.server === typeFilter;
                    return matchesSearch && matchesType;
                });

                // Apply sorting
                filteredAndSortedMaps.sort((a, b) => {
                    let valA, valB;
                    switch (sortBy) {
                        case 'map':
                            valA = a.map.toLowerCase();
                            valB = b.map.toLowerCase();
                            break;
                        case 'points':
                            valA = a.points || 0;
                            valB = b.points || 0;
                            break;
                        case 'stars':
                            valA = a.stars || 0;
                            valB = b.stars || 0;
                            break;
                        case 'timestamp':
                            valA = new Date(a.timestamp).getTime() || 0;
                            valB = new Date(b.timestamp).getTime() || 0;
                            break;
                        default:
                            valA = a.map.toLowerCase();
                            valB = b.map.toLowerCase();
                    }

                    if (typeof valA === 'string') {
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                    }
                });

                displayMaps(filteredAndSortedMaps);
            }

            // Display maps in the table
            function displayMaps(mapsToDisplay) {
                const tableBody = document.getElementById('mapsTableBody');
                tableBody.innerHTML = ''; 

                if (mapsToDisplay.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">No maps found matching your criteria.</td>
                        </tr>
                    `;
                    return;
                }

                mapsToDisplay.forEach(mapData => {
                    const row = tableBody.insertRow();
                    row.className = 'map-row';
                    row.onclick = () => showIndividualMap(mapData.map); 

                    const typeClass = getTypeClass(mapData.server);
                    const starsHtml = '★'.repeat(mapData.stars || 0) + '☆'.repeat(5 - (mapData.stars || 0));
                    row.innerHTML = `
                        <td>${mapData.map}</td>
                        <td><span class="type-badge ${typeClass}">${mapData.server}</span></td>
                        <td>${mapData.points || 'N/A'}</td>
                        <td><span class="stars">${starsHtml}</span></td>
                        <td>${mapData.mapper || 'Unknown'}</td>
                        <td>${formatDate(mapData.timestamp)}</td>
                        <td>
                            <button class="active-servers-btn" onclick="event.stopPropagation(); showIndividualMap(mapData.map)')">
                                More
                            </button>
                        </td>
                    `;
                });
            }

            // Sort table columns
            function sortTable(column) {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                filterAndSortMaps();
            }

            // --- Server Popup Functions (for map browser table) ---
            // This function uses the legacy /mapexists/ API for a quick list of servers from the main map table.
            async function showServersPopup(mapName) {
                const popup = document.getElementById('serversPopup');
                const overlay = document.getElementById('popupOverlay');
                const serversList = document.getElementById('serversList');

                serversList.innerHTML = `<div class="preview-loading"><div class="loading"></div><div>Loading servers...</div></div>`;
                popup.classList.add('show');
                overlay.classList.add('show');

                try {
                    const response = await fetch(`https://ddnet.org/mapexists/${encodeURIComponent(mapName)}`);
                    if (!response.ok) {
                        throw new Error('Could not fetch server data.');
                    }
                    const data = await response.json();
                    
                    serversList.innerHTML = ''; 

                    if (data.servers && data.servers.length > 0) {
                        data.servers.forEach(server => {
                            const serverItem = document.createElement('div');
                            serverItem.className = 'server-item';
                            serverItem.innerHTML = `
                                <div class="server-name">${server.name}</div>
                                <div class="server-info">
                                    Players: ${server.current_players}/${server.max_players} | 
                                    Gametype: ${server.gametype} | 
                                    Version: ${server.version}
                                </div>
                            `;
                            serverItem.onclick = () => {
                                navigator.clipboard.writeText(server.address)
                                    .then(() => {
                                        showToast('Server address copied to clipboard!');
                                    })
                                    .catch(err => {
                                        console.error('Failed to copy address:', err);
                                        showToast('Failed to copy server address.', true);
                                    });
                            };
                            serversList.appendChild(serverItem);
                        });
                    } else {
                        serversList.innerHTML = `<div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 20px;">No active servers found for this map.</div>`;
                    }

                } catch (error) {
                    console.error('Error fetching servers:', error);
                    serversList.innerHTML = `<div style="text-align: center; color: #ff4444; padding: 20px;">Failed to load servers.</div>`;
                }
            }

            function closeServersPopup() {
                document.getElementById('serversPopup').classList.remove('show');
                document.getElementById('popupOverlay').classList.remove('show');
            }

            // --- Maximized Preview Functions ---

            function maximizeIndividualPreview() {
                const iframeSrc = document.querySelector('#individualMapPreview iframe').src;
                if (iframeSrc) {
                    document.getElementById('maximizedIframe').src = iframeSrc;
                    document.getElementById('maximizedPreview').classList.add('show');
                }
            }

            function closeMaximizedPreview() {
                document.getElementById('maximizedPreview').classList.remove('show');
                document.getElementById('maximizedIframe').src = ''; 
            }

            // --- Individual Map Page Functions ---

            // Check for URL parameters on page load to determine initial view
            function checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const mapParam = urlParams.get('map');
                
                if (mapParam) {
                    showIndividualMap(decodeURIComponent(mapParam));
                } else {
                    showMapsBrowser();
                }
            }

            // Show maps browser view
            function showMapsBrowser() {
                document.getElementById('mapsBrowser').style.display = 'block';
                document.getElementById('individualMap').classList.remove('show');
                
                const url = new URL(window.location);
                url.searchParams.delete('map');
                window.history.pushState({}, '', url);
            }

            // Show individual map view
            function showIndividualMap(mapName) {
                document.getElementById('mapsBrowser').style.display = 'none';
                document.getElementById('individualMap').classList.add('show');
                
                const url = new URL(window.location);
                url.searchParams.set('map', encodeURIComponent(mapName));
                window.history.pushState({}, '', url);
                
                loadIndividualMapData(mapName);
            }

            // Go back to map browser
            function goBackToMapBrowser() {
                showMapsBrowser();
            }

            // Load all data for individual map using ddstats.tw/map/json and status.tw/map/name
            async function loadIndividualMapData(mapName) {
                try {
                    // Fetch full map details from the /map/json endpoint (DDStats)
                    const ddstatsResponse = await fetch(`https://ddstats.tw/map/json?map=${encodeURIComponent(mapName)}`);
                    if (!ddstatsResponse.ok) {
                        throw new Error(`Could not fetch DDStats data for map: ${mapName}`);
                    }
                    const mapData = await ddstatsResponse.json();
                    
                    if (!mapData || !mapData.info || !mapData.info.map) {
                        throw new Error('DDStats map data structure is invalid or map not found.');
                    }

                    currentIndividualMap = mapData; 

                    displayIndividualMap(currentIndividualMap.info.map); 
                    loadIndividualMapPreview(mapName); 
                    displayMapRankings(currentIndividualMap.rankings);
                    displayMapPlaytime(currentIndividualMap.playtime);

                    // Load live server data from status.tw API
                    const statusResponse = await fetch(`https://api.status.tw/map/name/${encodeURIComponent(mapName)}`);
                    if (!statusResponse.ok) {
                        throw new Error('Could not fetch live server data for this map from status.tw.');
                    }
                    currentLiveServerData = await statusResponse.json();
                    
                    
                    displayDetailedServerTable(currentLiveServerData.servers); // Display table

                } catch (error) {
                    console.error('Error loading individual map:', error);
                    document.getElementById('individualMapTitle').textContent = 'Error';
                    document.getElementById('individualMapSubtitle').textContent = 'Failed to load map information';
                    document.getElementById('individualMapInfo').innerHTML = `
                        <div class="large-stat-item">
                            <span class="large-stat-label" style="color: #ff4444;">Error</span>
                            <span class="large-stat-value">Map not found or data error</span>
                        </div>
                    `;
                    document.getElementById('individualMapPreview').innerHTML = `
                        <div class="preview-error">Failed to load preview.</div>
                    `;
                    document.getElementById('individualMapServers').innerHTML = `
                        <div style="text-align: center; color: #ff4444; grid-column: 1 / -1;">Failed to load servers.</div>
                    `;
                    document.getElementById('detailedServersTableBody').innerHTML = `
                        <tr><td colspan="6" style="padding: 20px; color: #ff4444;">Failed to load detailed server list.</td></tr>
                    `;
                    document.getElementById('mapRankingsTableBody').innerHTML = `
                        <tr><td colspan="6" style="padding: 20px; color: #ff4444;">Failed to load rankings.</td></tr>
                    `;
                    document.getElementById('mapPlaytimeTableBody').innerHTML = `
                        <tr><td colspan="3" style="padding: 20px; color: #ff4444;">Failed to load playtime data.</td></tr>
                    `;
                }
            }

            // Display individual map information (from mapData.info.map)
            function displayIndividualMap(mapInfo) {
                const typeClass = getTypeClass(mapInfo.server);
                const starsHtml = '★'.repeat(mapInfo.stars || 0) + '☆'.repeat(5 - (mapInfo.stars || 0));
                
                document.getElementById('individualMapTitle').textContent = mapInfo.map;
                document.getElementById('individualMapSubtitle').textContent = `${mapInfo.server} • ${mapInfo.points} Points • By ${mapInfo.mapper || 'Unknown'}`;
                
                document.getElementById('individualMapInfo').innerHTML = `
                    <div class="large-stat-item">
                        <span class="large-stat-label">Map Name:</span>
                        <span class="large-stat-value">${mapInfo.map}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Type:</span>
                        <span class="large-stat-value"><span class="type-badge ${typeClass}">${mapInfo.server}</span></span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Points:</span>
                        <span class="large-stat-value">${mapInfo.points}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Difficulty:</span>
                        <span class="large-stat-value stars">${starsHtml}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Mapper:</span>
                        <span class="large-stat-value">${mapInfo.mapper || 'Unknown'}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Release Date:</span>
                        <span class="large-stat-value">${formatDate(mapInfo.timestamp)}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Total Finishes:</span>
                        <span class="large-stat-value">${currentIndividualMap.info.finishes || 0}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Finishes Rank:</span>
                        <span class="large-stat-value">${currentIndividualMap.info.finishes_rank || 'N/A'}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Median Time:</span>
                        <span class="large-stat-value">${currentIndividualMap.info.median_time ? formatTimeDetailed(currentIndividualMap.info.median_time) : 'N/A'}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Total Playtime:</span>
                        <span class="large-stat-value">${formatTime(currentIndividualMap.info.total_playtime)}</span>
                    </div>
                    <div class="large-stat-item">
                        <span class="large-stat-label">Total Playtime Rank:</span>
                        <span class="large-stat-value">${currentIndividualMap.info.total_playtime_rank || 'N/A'}</span>
                    </div>
                `;
            }

            // Load individual map preview (uses ddnet.org for the preview image)
            function loadIndividualMapPreview(mapName) {
                const previewContainer = document.getElementById('individualMapPreview');
                previewContainer.innerHTML = `
                    <div class="preview-loading">
                        <div class="loading"></div>
                        <div>Loading preview...</div>
                    </div>
                    <button class="maximize-btn" onclick="maximizeIndividualPreview()">⛶</button>
                `;

                const encodedMapName = encodeURIComponent(mapName);
                const previewUrl = `https://ddnet.org/mappreview/?map=${encodedMapName}`;
                
                const iframe = document.createElement('iframe');
                iframe.src = previewUrl;
                
                iframe.onload = () => {
                    previewContainer.querySelector('.preview-loading').style.display = 'none';
                    iframe.style.display = 'block';
                    iframe.loading = 'lazy';
                };
                iframe.onerror = () => {
                    previewContainer.innerHTML = `
                        <div class="preview-error">Failed to load map preview.</div>
                        <button class="maximize-btn" onclick="maximizeIndividualPreview()">⛶</button>
                    `;
                };
                iframe.style.display = 'none'; 
                previewContainer.appendChild(iframe);
            }

            // Display active servers for individual map using status.tw API (as cards)
            function loadAndDisplayIndividualMapServers(liveServerData) {
                const serversGrid = document.getElementById('individualMapServers');
                serversGrid.innerHTML = ''; 

                if (liveServerData && liveServerData.servers && liveServerData.servers.length > 0) {
                    liveServerData.servers.forEach(server => {
                        const serverItem = document.createElement('div');
                        serverItem.className = 'large-server-item';
                        serverItem.innerHTML = `
                            <div class="large-server-name">${server.name}</div>
                            <div class="large-server-info">
                                Players: ${server.numPlayers}/${server.maxPlayers} | 
                                Clients: ${server.numClients}/${server.maxClients} |
                                Gametype: ${server.gameType ? server.gameType.name : 'N/A'}
                            </div>
                        `;
                        serverItem.onclick = () => {
                            showServerDetailsPopup(server);
                        };
                        serversGrid.appendChild(serverItem);
                    });
                } else {
                    serversGrid.innerHTML = `<div style="text-align: center; color: rgba(255, 255, 255, 0.7); grid-column: 1 / -1;">No live servers found for this map.</div>`;
                }
            }

            // Display map rankings (individual)
            function displayMapRankings(rankings) {
                const rankingsTableBody = document.getElementById('mapRankingsTableBody');
                rankingsTableBody.innerHTML = ''; 

                if (rankings && rankings.length > 0) {
                    const rank1Time = rankings[0].time; // Get the time of the first rank
                    rankings.slice(0, 10).forEach(rank => { 
                        const diffFromRank1 = rank.rank === 1 ? '0.00s' : `+${(rank.time - rank1Time).toFixed(2)}s`;
                        const row = rankingsTableBody.insertRow();
                        row.innerHTML = `
                            <td>${rank.rank}</td>
                            <td onclick="navigateToPage('players.html?player=${encodeURIComponent(rank.name)}')" style="text-decoration: underline; cursor: pointer;">${rank.name}</td>
                            <td>${formatTimeDetailed(rank.time)}</td>
                            <td>${diffFromRank1}</td>
                            <td>${formatDate(rank.timestamp)}</td>
                            <td>${rank.server}</td>
                        `;
                    });
                } else {
                    rankingsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">No individual rankings found for this map.</td>
                        </tr>
                    `;
                }
            }

            // Display map playtime (from mapData.total_playtime_players)
            function displayMapPlaytime(playtimePlayers) {
                const playtimeTableBody = document.getElementById('mapPlaytimeTableBody');
                playtimeTableBody.innerHTML = ''; 

                if (playtimePlayers && playtimePlayers.length > 0) {
                    playtimePlayers.slice(0, 10).forEach((player, index) => { 
                        const row = playtimeTableBody.insertRow();
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td onclick="navigateToPage('players.html?player=${encodeURIComponent(player.name)}')" style="text-decoration: underline; cursor: pointer;">${player.name}</td>
                            <td>${formatTime(player.seconds_played)}</td>
                        `;
                    });
                } else {
                    playtimeTableBody.innerHTML = `
                        <tr>
                            <td colspan="3" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">No playtime data found for this map.</td>
                        </tr>
                    `;
                }
            }

            // --- New Detailed Server Table Function ---
            function displayDetailedServerTable(servers) {
                const detailedServersTableBody = document.getElementById('detailedServersTableBody');
                detailedServersTableBody.innerHTML = ''; // Clear existing content

                if (servers && servers.length > 0) {
                    servers.forEach(server => {
                        const row = detailedServersTableBody.insertRow();
                        row.innerHTML = `
                            <td>${server.name}</td>
                            <td>${server.numPlayers}/${server.maxPlayers}</td>
                            <td>${server.gameType ? server.gameType.name : 'N/A'}</td>
                            <td>${server.version ? server.version.version : 'N/A'}</td>
                            <td><button class="active-servers-btn" onclick="showServerDetailsPopup(currentLiveServerData.servers.find(s => s.ip === '${server.ip}' && s.port === ${server.port}))">Details</button></td>
                        `;
                    });
                } else {
                    detailedServersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; color: rgba(255, 255, 255, 0.7);">No detailed server data available.</td>
                        </tr>
                    `;
                }
            }

            // --- Server Details Popup Functions ---
            function showServerDetailsPopup(serverData) {
                const popup = document.getElementById('serverDetailsPopup');
                const overlay = document.getElementById('serverDetailsOverlay');
                const title = document.getElementById('serverDetailsTitle');
                const content = document.getElementById('serverDetailsContent');

                title.textContent = serverData.name;
                content.innerHTML = `
                    <p><strong>IP:</strong> ${serverData.ip}:${serverData.port}</p>
                    <p><strong>Players:</strong> ${serverData.numPlayers}/${serverData.maxPlayers}</p>
                    <p><strong>Gametype:</strong> ${serverData.gameType ? serverData.gameType.name : 'N/A'}</p>
                    <p><strong>Version:</strong> ${serverData.version ? serverData.version.version : 'N/A'}</p>
                    <h4 style="color: var(--primary-color); margin-top: 20px; margin-bottom: 10px; text-align: center;">Players:</h4>
                    <div id="serverClientsListContainer"></div>
                `;

                const clientsListContainer = document.getElementById('serverClientsListContainer');
                if (serverData.clients && serverData.clients.length > 0) {
                    // Group clients by team
                    const teams = {};
                    serverData.clients.forEach(client => {
                        const teamKey = client.team === -1 ? 'Spectators' : `Team ${client.team}`;
                        if (!teams[teamKey]) {
                            teams[teamKey] = [];
                        }
                        teams[teamKey].push(client);
                    });

                    // Display clients, grouped by team in tables
                    for (const teamKey in teams) {
                        clientsListContainer.innerHTML += `<h5 style="color: var(--primary-color); margin-top: 15px; margin-bottom: 5px; text-align: center;">${teamKey} (${teams[teamKey].length} players)</h5>`;
                        
    const teamTable = document.createElement('table');
                        teamTable.className = 'server-client-list-table';
                        teamTable.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Score</th>
                                    <th>Country</th>
                                    <th>Clan</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        const teamTableBody = teamTable.querySelector('tbody');

                        // Sort the clients by score before iterating
                        const sortedClients = [...teams[teamKey]].sort((a, b) => {
                            // Handle -9999 as a special case for sorting (e.g., put them at the end)
                            if (a.score === -9999 && b.score === -9999) return 0;
                            if (a.score === -9999) return 1; // 'a' is N/A, put it after 'b'
                            if (b.score === -9999) return -1; // 'b' is N/A, put it after 'a'

                            // Sort numerically for actual scores
                            return a.score - b.score; // For descending order (highest score first)
                            // return a.score - b.score; // For ascending order (lowest score first)
                        });

                        sortedClients.forEach(client => {
                            const row = teamTableBody.insertRow();
                            row.innerHTML = `
                                <td>${client.name}</td>
                                <td>${client.score === -9999 ? 'N/A' : formatTime(client.score)}</td>
                                <td><img src="${client.country.iconUrl}" onerror="this.onerror=null;this.src='https://cdn.status.tw/flags/default.png';" title="${client.country.identifier}"> ${client.country.identifier === 'default' ? 'Default' : client.country.identifier}</td>
                                <td>${client.clan ? client.clan.name : 'N/A'}</td>
                            `;
                        });
                        clientsListContainer.appendChild(teamTable);
                    }
                } else {
                    clientsListContainer.innerHTML = `<p style="text-align: center; color: rgba(255, 255, 255, 0.7);">No clients currently on this server.</p>`;
                }

                popup.classList.add('show');
                overlay.classList.add('show');
            }

            function closeServerDetailsPopup() {
                document.getElementById('serverDetailsPopup').classList.remove('show');
                document.getElementById('serverDetailsOverlay').classList.remove('show');
                document.getElementById('serverDetailsContent').innerHTML = ''; 
            }

            // Event Listeners
            document.addEventListener('DOMContentLoaded', () => {
                loadMaps(); 
                document.getElementById('mapSearch').addEventListener('input', filterAndSortMaps);
                document.getElementById('typeFilter').addEventListener('change', filterAndSortMaps);
                document.getElementById('sortBy').addEventListener('change', filterAndSortMaps);
                
                checkUrlParams();
            });
        </script>
    </body>
    </html>
